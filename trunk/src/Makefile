#
# This is the libsmi/src Makefile.
#
# @(#) $Id: Makefile,v 1.5 1998/11/10 20:25:43 strauss Exp $
#

CC	= gcc
CFLAGS	= -Wall -g -DTEXTS_IN_MEMORY=200 -DPARSER

# We need flex and bison. Lex and yacc do not work.
LEX	= flex
YACC	= bison -y -v -t

RPCGEN	= rpcgen

LOBJS	= config.o scanner-flex.o parser-bison.o error.o data.o smi.o

default: libsmi.a miblint

smi_xdr.c smi_svc.c smi_clnt.c smi.h: smi.x smi.h-add
	$(RPCGEN) smi.x
	cat smi.h-add >> smi.h

smi.o: smi.c smi.h

smid: smid.o smi_svc.o libsmi.a

smid.o: smid.c smi.h

scanner-flex.c: scanner.l scanner.h parser-bison.h
	$(LEX) -t scanner.l > scanner-flex.c

parser-bison.c parser-bison.h: parser.y scanner.h parser.h
	$(YACC) -d parser.y
	mv y.tab.c parser-bison-buggy.c
	mv y.tab.h parser-bison.h
#	there's a slight bug in bison 1.25 with pure reentrant parsers:
	sed -e 's/int yyparse (void);/int yyparse ();/' \
	    parser-bison-buggy.c > parser-bison.c

scanner-flex.o: scanner-flex.c scanner.h error.h defs.h

parser-bison.o: parser-bison.c parser-bison.h parser.h error.h defs.h config.h

config.o: parser-bison.c config.c config.h defs.h smi.h

error.o: error.c error.h defs.h smi.h

data.o: data.c data.h defs.h smi.h

lint.o: lint.c error.h defs.h smi.h


libsmi.a: $(LOBJS)
	ar ruv libsmi.a $(LOBJS)
	ranlib libsmi.a
	ln -f smi.h ../smi.h
	ln -f libsmi.a ../libsmi.a

miblint: libsmi.a lint.o
	$(CC) -o miblint lint.o libsmi.a -ll
	ln -f miblint ..


yacc2html.c: yacc2html.l
	$(LEX) -t yacc2html.l > yacc2html.c

yacc2html: yacc2html.o
	$(CC) -o yacc2html yacc2html.o -ll

parser.y.html: parser.y yacc2html
	echo '<HTML><HEAD><TITLE>parser.y</TITLE></HEAD><BODY><PRE>' \
	    > parser.y.html
	cat parser.y | \
	    sed -e 's!<!\&lt;!g' -e 's!>!\&gt;!g' | \
	    ./yacc2html | \
	    sed -e 's!REF:RFC\([0-9]*\),\([0-9\.]*\)!REF:<A HREF="http://www.ibr.cs.tu-bs.de/doc/rfc?PATTERN=\1#\2">RFC\1,\2</A>!g' \
	    >> parser.y.html
	echo '</PRE></BODY></HTML>' >> parser.y.html
	ln -f parser.y.html ..

clean:
	rm -f scanner-flex.c scanner-flex.o
	rm -f parser-bison.c parser-bison-buggy.c parser-bison.h parser-bison.o
	rm -f error.o lint.o data.o interface.o config.o
	rm -f core
	rm -f miblint smi.h libsmi.a smi_xdr.c smi_svc.c smi_clnt.c smi.o
	rm -f y.tab.c y.tab.h y.output yacc.debug yacc.acts yacc.tmp
	rm -f yacc2html.c yacc2html.o yacc2html parser.y.html
