#
# This is the libsmi Makefile.in.
#
# @(#) $Id$
#

LIBSMI_VERSION	= @LIBSMI_VERSION@

#MIBDIR		= /usr/local/lib/tnm3.0.0/mibs
#TESTMIBS	= `cd $(MIBDIR) ; ls -1 IAN* IF-MIB ATM-* SNMPv2-MIB SNMPv2-TC`
MIBDIR		= mibs/smiv2
#TESTMIBS	= `cd $(MIBDIR) ; ls -1 *`
TESTMIBS	= ""

PREFIX			= @prefix@
LIB_RUNTIME_DIR		= @prefix@/lib
BIN_INSTALL_DIR		= $(PREFIX)/bin
LIB_INSTALL_DIR		= $(PREFIX)/lib
INCLUDE_INSTALL_DIR	= $(PREFIX)/include
MAN1_INSTALL_DIR	= $(PREFIX)/man/man1
MAN3_INSTALL_DIR	= $(PREFIX)/man/man3

CC		= @CC@
LD		= @CC@
LD_FLAGS	= @LD_FLAGS@
RANLIB		= @RANLIB@
INSTALL		= @INSTALL@
AR		= ar
YACC		= bison
LEX		= flex
DEFS		= @DEFS@
SHLIB_CFLAGS	= @SHLIB_CFLAGS@
CFLAGS		= -Ilib @CFLAGS@ @SHLIB_CFLAGS@ $(DEFS)
SHLIB_LD	= @SHLIB_LD@
SHLIB_SUFFIX	= @SHLIB_SUFFIX@

LIBSMI_OBJS	= lib/data.o lib/error.o lib/util.o lib/smi.o lib/scanner.o \
		  lib/parser-smi.tab.o lib/scanner-smi.o \
		  lib/parser-sming.tab.o lib/scanner-sming.o
LIBSMI_STATIC	= lib/libsmi.a
LIBSMI_SO	= lib/libsmi$(SHLIB_SUFFIX)

all: $(LIBSMI_STATIC) $(LIBSMI_SO) tools

$(LIBSMI_STATIC): $(LIBSMI_OBJS)
	$(AR) ruv $@ $(LIBSMI_OBJS)
	$(RANLIB) $@
	
$(LIBSMI_SO): $(LIBSMI_OBJS)
	$(SHLIB_LD) $(LIBSMI_OBJS) -o $(LIBSMI_SO)

lib/parser-smi.tab.c: lib/parser-smi.y lib/scanner-smi.h lib/parser-smi.h
	$(YACC) -v -t -d -psmi lib/parser-smi.y
#	# bison-1.25 has a wrong yyparse() definition for pure reentrant code.
#	# bison-1.27 is ok and would not the lines below.
	sed -e 's/int yyparse (void);/int yyparse ();/' \
	    lib/parser-smi.tab.c > lib/parser-smi.tab.c.tmp && \
	mv lib/parser-smi.tab.c.tmp lib/parser-smi.tab.c

lib/parser-sming.tab.c: lib/parser-sming.y lib/scanner-sming.h lib/parser-sming.h
	$(YACC) -v -t -d -psming lib/parser-sming.y
#	# bison-1.25 has a wrong yyparse() definition for pure reentrant code.
#	# bison-1.27 is ok and would not the lines below.
	sed -e 's/int yyparse (void);/int yyparse ();/' \
	    lib/parser-sming.tab.c > lib/parser-sming.tab.c.tmp && \
	mv lib/parser-sming.tab.c.tmp lib/parser-sming.tab.c

lib/scanner-smi.c: lib/scanner-smi.l lib/scanner-smi.h lib/parser-smi.tab.h
	$(LEX) -Psmi -t lib/scanner-smi.l > lib/scanner-smi.c

lib/scanner-sming.c: lib/scanner-sming.l lib/scanner-sming.h lib/parser-sming.tab.h
	$(LEX) -Psming -t lib/scanner-sming.l > lib/scanner-sming.c



#tools: tools/smilint tools/smidump tools/smiquery
tools: tools/smiquery

tools/smilint: $(LIBSMI_STATIC) tools/smilint.o
	$(LD) $(LDFLAGS) -o tools/smilint tools/smilint.o $(LIBSMI_STATIC)

tools/smisubtree: tools/smisubtree.o $(LIBSMI_STATIC)
	$(LD) $(LDFLAGS) -o tools/smisubtree $^

tools/smidump: tools/smidump.o tools/dump-sming.o tools/dump-smi.o tools/dump-data.o $(LIBSMI_STATIC)
	$(LD) $(LDFLAGS) -o tools/smidump $^

tools/smiquery: $(LIBSMI_SO) tools/smiquery.o
	$(LD) $(LDFLAGS) -o tools/smiquery tools/smiquery.o -Llib -lsmi



clean:
	rm -f lib/*.o lib/*.a lib/*.tab.[hc] lib/*.tab.c.tmp lib/scanner-smi.c lib/scanner-sming.c lib/*.output tools/*.o core */core doc/parser-smi.y.html test/*.log doc/yacc2html.o doc/yacc2html.c doc/scanner-sming.l.html



install: lib/smi.h $(LIBSMI_SO)
	$(INSTALL) lib/smi.h $(INCLUDE_INSTALL_DIR)/smi.h
	$(INSTALL) $(LIBSMI_SO) $(LIB_INSTALL_DIR)/libsmi.so.$(LIBSMI_VERSION)
	ln $(LIB_INSTALL_DIR)/libsmi.so.$(LIBSMI_VERSION) $(LIB_INSTALL_DIR)/libsmi.so
	$(INSTALL) tools/smilint $(BIN_INSTALL_DIR)/smilint
	$(INSTALL) tools/smidump $(BIN_INSTALL_DIR)/smidump
	$(INSTALL) tools/smiquery $(BIN_INSTALL_DIR)/smiquery
	$(INSTALL) doc/smilint.1 $(MAN1_INSTALL_DIR)/smilint.1
	$(INSTALL) doc/smidump.1 $(MAN1_INSTALL_DIR)/smidump.1
#	$(INSTALL) doc/smiquery.1 $(MAN1_INSTALL_DIR)/smiquery.1
	for f in doc/*.3 ; do \
		$(INSTALL) $f $(MAN3_INSTALL_DIR) ; \
	done
#	if [ ! -d ${PREFIX}/lib/smi ] ; then mkdir ${PREFIX}/lib/smi ; fi
#	if [ ! -d ${PREFIX}/lib/smi/mibs-smi ] ; then mkdir ${PREFIX}/lib/smi/mibs-smi ; fi
#	if [ ! -d ${PREFIX}/lib/smi/mibs-sming ] ; then mkdir ${PREFIX}/lib/smi/mibs-sming ; fi
#	-cp mibs/smi/* ${PREFIX}/lib/smi/mibs-smi
#	-cp mibs/sming/* ${PREFIX}/lib/smi/mibs-sming



test: test-smilint test-smidump-smi-sming test-smidump-sming-sming test-diffs

test-smilint: test-dir tools/smilint
	rm -f test/smilint.log
	for mib in $(TESTMIBS) ; do \
	    echo "### Testing: smilint $$mib" ; \
	    echo "### Testing: smilint $$mib" >> test/smilint.log ; \
	    tools/smilint -l9 -v -Lsming:mibs/sming -Lsmi:mibs/smi -Lsmi:mibs/smiv2 -Lsmi:mibs/smiv1 $$mib \
						   >> test/smilint.log 2>&1 ; \
	done | egrep -v '(^$$|^/)'
	@echo ""
	@echo "### See test/smilint.log for smilint test protocol."
	@echo ""

test-smidump-smi-sming: test-dir tools/smidump
	rm -rf test/smidump-smi-sming
	mkdir test/smidump-smi-sming
	for mib in $(TESTMIBS) ; do \
	    echo "### Testing: smidump -Dsming $$mib" ; \
	    tools/smidump -l0 -Lsming:mibs/sming -Lsmi:mibs/smi -Lsmi:mibs/smiv2 -Lsmi:mibs/smiv1 -Dsming $$mib \
					    >> test/smidump-smi-sming/$$mib ; \
	done
	@echo ""
	@echo "### See files in test/smidump-smi-sming/ for smidump output."
	@echo ""

test-smidump-sming-sming: test-dir tools/smidump
	rm -rf test/smidump-sming-sming
	mkdir test/smidump-sming-sming
	for mib in $(TESTMIBS) ; do \
	    echo "### Testing: smidump -Dsming $$mib" ; \
	    tools/smidump -l0 -Lsming:mibs/sming -Lsmi:mibs/smi -Lsming:test/smidump-smi-sming -Lsmi:mibs/smiv1 -Dsming $$mib \
					  >> test/smidump-sming-sming/$$mib ; \
	done
	@echo ""
	@echo "### See files in test/smidump-sming-sming/ for smidump output."
	@echo ""

test-diffs: test-smidump-smi-sming test-smidump-sming-sming
	rm -rf test/smidump-diffs
	mkdir test/smidump-diffs
	for mib in $(TESTMIBS) ; do \
	    echo "### Testing: smi-sming/sming-sming diffs of $$mib" ; \
	    diff test/smidump-smi-sming/$$mib \
		 test/smidump-sming-sming/$$mib > test/smidump-diffs/$$mib ; \
	done

test-dir:
	if [ ! -d test ] ; then mkdir test ; fi

dist:
	cd .. ; tar cvzf libsmi/libsmi.tar.gz `cat libsmi/MANIFEST | sed -e 's!^!libsmi/!'`

